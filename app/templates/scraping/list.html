{% extends 'layout.html' %}
{% block title %}Scraping Jobs{% endblock %}
{% block content %}
<h3>Scraping Jobs</h3>
<table class="table table-striped">
  <thead><tr><th>ID</th><th>Employee</th><th>Account</th><th>Status</th><th>Posts</th><th>Started</th><th>Actions</th></tr></thead>
  <tbody>
    {% for j in jobs.items %}
      <tr>
        <td><a href="{{ url_for('scraping.view_job', job_id=j.id) }}">#{{ j.id }}</a></td>
        <td>{{ j.social_account.employee.full_name }}</td>
        <td>{{ j.social_account.platform|capitalize }} / {{ j.social_account.username }}</td>
        <td>{{ j.status }}</td>
        <td>{{ j.posts_scraped }}</td>
        <td>{{ j.started_at }}</td>
        <td>
          <div class="btn-group" role="group" aria-label="Job actions">
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('scraping.view_job', job_id=j.id) }}">View</a>
            {% if j.status in ['running','pending'] %}
            <form class="d-inline" method="post" action="{{ url_for('scraping.refresh_job_status', job_id=j.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary">Refresh</button>
            </form>
            {% endif %}
            {% if current_user.can_trigger_scraping() %}
            <form class="d-inline" method="post" action="{{ url_for('scraping.delete_job', job_id=j.id) }}" onsubmit="return confirm('Delete job #{{ j.id }} and its results?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
<nav>
  <ul class="pagination">
    {% if jobs.has_prev %}
      <li class="page-item"><a class="page-link" href="?page={{ jobs.prev_num }}">Previous</a></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Page {{ jobs.page }} of {{ jobs.pages }}</span></li>
    {% if jobs.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ jobs.next_num }}">Next</a></li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
